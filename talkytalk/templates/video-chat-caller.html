<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>video chat</title>
</head>
<body>
<video autoplay></video>
<script>
    var es = new EventSource('/events/');

    es.addEventListener('message', function (e) {
        console.log(e.data);
    }, false);

    es.addEventListener('stream-reset', function (e) {
        // ... client fell behind, reinitialize ...
        console.log(e)
    }, false);

    const SignalingChannel = function () {
        this.send = function (data) {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", '/server', true);
            xhr.onreadystatechange = function () { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    console.log('signal has been sent');
                }
            };
            xhr.send(data);
        };

        this.onmessage = function (message) {
            console.log('message received!!! : ' + message)
        };
    };

    const pc = new RTCPeerConnection();


    function gotStream(stream) {
        let video = document.querySelector('video');

        //insert stream into the video tag
        video.src = window.URL.createObjectURL(stream);


        pc.onaddstream(stream);
        pc.createOffer(function (offer) {
            pc.setLocalDescription(offer);
            SignalingChannel.send(offer.sdp)
        })
    }

    pc.onicecandidate = function (event) {
        if (event.candidate) {
            SignalingChannel.send(event.candidate)
        }
    };

    SignalingChannel.onmessage = function (message) {
        if (message.candidate) {
            pc.addIceCandidate(message.candidate)
        }
    };

    pc.onconnectionstatechange = function (event) {
        console.log("conn state change : " + event.target.iceConnectionState)
    };

    function hasUserMedia() {
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia
            || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        return !!navigator.getUserMedia;
    }

    if (hasUserMedia()) {
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia
            || navigator.mozGetUserMedia || navigator.msGetUserMedia;

        //get both video and audio streams from user's camera
        navigator.getUserMedia({video: true}, gotStream, function () {
            console.log('error getting stram')
        });

    } else {
        alert("Error. WebRTC is not supported!");
    }


</script>
</body>
</html>
